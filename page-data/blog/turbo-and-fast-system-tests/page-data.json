{"componentChunkName":"component---src-templates-blog-jsx","path":"/blog/turbo-and-fast-system-tests/","result":{"data":{"markdownRemark":{"html":"<p>Rails allows us to build rich UIs without writing Javascript. Rails also allows us to test those UIs without an actual browser.</p>\n<p>This post is focused on that last capability. And on how <a href=\"https://turbo.hotwired.dev/\" target=\"_blank\" rel=\"nofollow\">Turbo</a> extends it even further.</p>\n<p>But before we begin let’s take a look into why testing UIs without browser is something worth doing. Feel free to <a href=\"#rails-system-tests\">skip over</a> the next part if you must see the code <em>now</em>.</p>\n<h2 id=\"browser-testing\" style=\"position:relative;\"><a href=\"#browser-testing\" aria-label=\"browser testing permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Browser testing</h2>\n<h3 id=\"problem\" style=\"position:relative;\"><a href=\"#problem\" aria-label=\"problem permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Problem</h3>\n<p>Rails system tests are slow (compared to model and controller tests) because they drive the application via real browser. This affects both start up and execution times. In addition to being slow, browser tests are harder to debug because the state of the app is spread across two independent processes: ruby server and browser client.</p>\n<h3 id=\"alternative\" style=\"position:relative;\"><a href=\"#alternative\" aria-label=\"alternative permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Alternative</h3>\n<p>Rails is using Capybara to drive the UI in system tests. Capybara in turn is using <code class=\"language-text\">selenium</code> driver to communicate with the browser. There is, however, another driver called <code class=\"language-text\">rack_test</code>. It plugs Capybara directly into the request middleware stack, bypassing the need to actually run the server and open the browser in order to be able to visit urls, click links, submit forms and so on. Effectively, under <code class=\"language-text\">rack_test</code> system tests are using the same underlying machinery as controller tests.</p>\n<p>This is a cool party trick, but this way Capybara will no longer exercise any javascript. Unless our application is <em>somehow</em> functional without javascript as well. Sounds like a lot of work, but this is where Rails has a few tricks to offer. And even more so with the advent of Turbo.</p>\n<p>Rails sticks to server-side rendering and progressive enhancement (PE). The latter is what allows our application to function without javascript. So far PE in Rails was supported by <a href=\"https://guides.rubyonrails.org/working_with_javascript_in_rails.html#turbolinks\" target=\"_blank\" rel=\"nofollow\">Turbolinks</a> and <a href=\"https://guides.rubyonrails.org/working_with_javascript_in_rails.html#unobtrusive-javascript\" target=\"_blank\" rel=\"nofollow\">UJS</a>, but that, without going into details, was a fairly basic tech.</p>\n<p>Now meet <a href=\"https://turbo.hotwired.dev/\" target=\"_blank\" rel=\"nofollow\">Turbo</a>, part of the <a href=\"https://hotwired.dev/\" target=\"_blank\" rel=\"nofollow\">Hotwire</a> family. Turbo has <a href=\"https://turbo.hotwired.dev/handbook/drive\" target=\"_blank\" rel=\"nofollow\">Drive</a>, which is just a more polished, streamlined version of what was already largely possible with Turbolinks + UJS. It also has <a href=\"https://turbo.hotwired.dev/handbook/frames\" target=\"_blank\" rel=\"nofollow\">Frames</a>. Frames is a brand new capability that allows you to update parts of the page independently. Finally there are <a href=\"https://turbo.hotwired.dev/handbook/streams\" target=\"_blank\" rel=\"nofollow\">Streams</a>, another addition that provides a DSL for “gluing” bits of server side rendered html into the dom on the client side.</p>\n<p>All the while sticking to server side rendering only. And if everything is rendered by rails controllers, then switching to <code class=\"language-text\">rack_test</code> doesn’t actually sound like a big deal.</p>\n<p>It’s important to note that the end game is not to replace <code class=\"language-text\">selenium</code> with <code class=\"language-text\">rack_test</code>, but to be able to run the same tests in <em>both</em> modes. <code class=\"language-text\">rack_test</code> for speed and ease of debugging, followed by <code class=\"language-text\">selenium</code> for the ultimate confidence.</p>\n<p>With that in mind, let’s see what it takes to achieve this in practice.</p>\n<h2 id=\"rails-system-tests\" style=\"position:relative;\"><a href=\"#rails-system-tests\" aria-label=\"rails system tests permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Rails system tests</h2>\n<p>Out of the box, Rails 6/7 system tests pop up a Chrome browser (<code class=\"language-text\">test/application_system_test_case.rb</code>):</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\"><span class=\"token keyword\">require</span> <span class=\"token string-literal\"><span class=\"token string\">\"test_helper\"</span></span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">ApplicationSystemTestCase</span> <span class=\"token operator\">&lt;</span> ActionDispatch<span class=\"token double-colon punctuation\">::</span>SystemTestCase\n  driven_by <span class=\"token symbol\">:selenium</span><span class=\"token punctuation\">,</span> <span class=\"token symbol\">using</span><span class=\"token operator\">:</span> <span class=\"token symbol\">:chrome</span><span class=\"token punctuation\">,</span> <span class=\"token symbol\">screen_size</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token number\">1400</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1400</span><span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">end</span></code></pre></div>\n<h3 id=\"going-headless\" style=\"position:relative;\"><a href=\"#going-headless\" aria-label=\"going headless permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Going headless</h3>\n<p>The browser window flashing is a distraction so the first thing to do is to switch to headless mode by default (rails also registers <code class=\"language-text\">:headless_chrome</code> driver):</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\"><span class=\"token keyword\">require</span> <span class=\"token string-literal\"><span class=\"token string\">'test_helper'</span></span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">ApplicationSystemTestCase</span> <span class=\"token operator\">&lt;</span> ActionDispatch<span class=\"token double-colon punctuation\">::</span>SystemTestCase\n  driven_by <span class=\"token symbol\">:selenium</span><span class=\"token punctuation\">,</span> <span class=\"token symbol\">using</span><span class=\"token operator\">:</span> <span class=\"token constant\">ENV</span><span class=\"token punctuation\">[</span><span class=\"token string-literal\"><span class=\"token string\">'GUI'</span></span><span class=\"token punctuation\">]</span> <span class=\"token operator\">?</span> <span class=\"token symbol\">:chrome</span> <span class=\"token operator\">:</span> <span class=\"token symbol\">:headless_chrome</span>\n<span class=\"token keyword\">end</span></code></pre></div>\n<p>The original GUI version can be turned on with an environment variable: <code class=\"language-text\">GUI=1 rails test:system</code>. As a bonus, headless tests are slightly faster.</p>\n<h3 id=\"rack_test\" style=\"position:relative;\"><a href=\"#rack_test\" aria-label=\"rack_test permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>rack_test</h3>\n<p>Now let’s go for full glory. <code class=\"language-text\">rails test:system</code> is going to run purely in ruby. <code class=\"language-text\">JS=1 rails test:system</code> will run in a headless browser and <code class=\"language-text\">GUI=1 rails test:system</code> will open a regular browser.</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">ApplicationSystemTestCase</span> <span class=\"token operator\">&lt;</span> ActionDispatch<span class=\"token double-colon punctuation\">::</span>SystemTestCase\n  <span class=\"token keyword\">def</span> <span class=\"token method-definition\"><span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span><span class=\"token function\">js</span></span><span class=\"token operator\">?</span>\n    <span class=\"token constant\">ENV</span><span class=\"token punctuation\">[</span><span class=\"token string-literal\"><span class=\"token string\">'JS'</span></span><span class=\"token punctuation\">]</span> <span class=\"token operator\">||</span> <span class=\"token constant\">ENV</span><span class=\"token punctuation\">[</span><span class=\"token string-literal\"><span class=\"token string\">'GUI'</span></span><span class=\"token punctuation\">]</span>\n  <span class=\"token keyword\">end</span>\n\n  <span class=\"token keyword\">if</span> js<span class=\"token operator\">?</span>\n    driven_by <span class=\"token symbol\">:selenium</span><span class=\"token punctuation\">,</span> <span class=\"token symbol\">using</span><span class=\"token operator\">:</span> <span class=\"token constant\">ENV</span><span class=\"token punctuation\">[</span><span class=\"token string-literal\"><span class=\"token string\">'GUI'</span></span><span class=\"token punctuation\">]</span> <span class=\"token operator\">?</span> <span class=\"token symbol\">:chrome</span> <span class=\"token operator\">:</span> <span class=\"token symbol\">:headless_chrome</span>\n  <span class=\"token keyword\">else</span>\n    driven_by <span class=\"token symbol\">:rack_test</span>\n  <span class=\"token keyword\">end</span>\n<span class=\"token keyword\">end</span></code></pre></div>\n<br>\n<p><em><code class=\"language-text\">rack_test</code> ships with Capybara by default, no need to install extra gems.</em></p>\n<h2 id=\"dealing-with-javascript\" style=\"position:relative;\"><a href=\"#dealing-with-javascript\" aria-label=\"dealing with javascript permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Dealing with Javascript</h2>\n<p>Now that we can run system tests in ruby, let’s see what can be done about JavaScript powered features that can’t be tested with <code class=\"language-text\">rack_test</code>.</p>\n<h3 id=\"opting-out-of-rack_test\" style=\"position:relative;\"><a href=\"#opting-out-of-rack_test\" aria-label=\"opting out of rack_test permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Opting out of rack_test</h3>\n<p>Some features are more client side than others (for example, embedded payment iframe) to the point that it does not make sense to have a <code class=\"language-text\">rack_test</code> version. In this case, you can simply wrap related tests in <code class=\"language-text\">if js?</code> to make them only run in the real browser.</p>\n<p>Or you can opt out of <code class=\"language-text\">rack_test</code> by default and gradually add existing tests in as and when to avoid “all or nothing” upgrade.</p>\n<h3 id=\"changing-tests-to-support-both-modes\" style=\"position:relative;\"><a href=\"#changing-tests-to-support-both-modes\" aria-label=\"changing tests to support both modes permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Changing tests to support both modes</h3>\n<p>While it makes sense in some cases, excluding tests from <code class=\"language-text\">rack_test</code> defeats the whole point. Sometimes the difference between javascript and non-js versions is cosmetic and can be captured in a test helper. That’s a low hanging fruit.\nFor example, javascript confirm dialog only exists in the actual browser. We can make a helper method that will confirm the dialog when the test runs in javascript or otherwise do nothing:</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\"><span class=\"token keyword\">def</span> <span class=\"token method-definition\"><span class=\"token function\">confirm</span></span>\n  js<span class=\"token operator\">?</span> <span class=\"token operator\">?</span> accept_confirm <span class=\"token punctuation\">{</span> <span class=\"token keyword\">yield</span> <span class=\"token punctuation\">}</span> <span class=\"token operator\">:</span> <span class=\"token keyword\">yield</span>\n<span class=\"token keyword\">end</span></code></pre></div>\n<p>And then somewhere in the test:</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\">confirm <span class=\"token punctuation\">{</span> click_button <span class=\"token string-literal\"><span class=\"token string\">'Destroy'</span></span> <span class=\"token punctuation\">}</span></code></pre></div>\n<p>Naturally, you’ll find yourself minimizing the differences between javascript and non-js versions of your site and that is actually good thing.</p>\n<h3 id=\"changing-views-to-support-both-modes\" style=\"position:relative;\"><a href=\"#changing-views-to-support-both-modes\" aria-label=\"changing views to support both modes permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Changing views to support both modes</h3>\n<p>Imagine a form with a single checkbox that automatically submits whenever checkbox is toggled. This can only be done in JavaScript. For the non-JS version we can add a “Submit” button that is only shown when the form page is viewed without JavaScript.</p>\n<p>There is a clever trick to support this kind of extra non-JS controls. Add the following to the top layout file:</p>\n<div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>html</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>no-js<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>head</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>style</span><span class=\"token punctuation\">></span></span><span class=\"token style\"><span class=\"token language-css\"><span class=\"token selector\">.js .js-hidden</span> <span class=\"token punctuation\">{</span> <span class=\"token property\">display</span><span class=\"token punctuation\">:</span> none<span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>style</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span><span class=\"token punctuation\">></span></span><span class=\"token script\"><span class=\"token language-javascript\">document<span class=\"token punctuation\">.</span>documentElement<span class=\"token punctuation\">.</span>className <span class=\"token operator\">=</span> <span class=\"token string\">'js'</span></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>When JavaScript is enabled, the script will replace top element class name from <code class=\"language-text\">no-js</code> to <code class=\"language-text\">js</code>, thus activating the <code class=\"language-text\">.js-hidden</code> CSS rule. Now we can add <code class=\"language-text\">js-hidden</code> class to the submit button (or indeed anything that we don’t want regular users to see):</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\"><span class=\"token operator\">&lt;</span><span class=\"token operator\">%=</span> f<span class=\"token punctuation\">.</span>submit<span class=\"token punctuation\">,</span> <span class=\"token symbol\">class</span><span class=\"token operator\">:</span> <span class=\"token string-literal\"><span class=\"token string\">'js-hidden'</span></span> <span class=\"token operator\">%</span><span class=\"token operator\">></span></code></pre></div>\n<p>Then in tests:</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\">click_button <span class=\"token string-literal\"><span class=\"token string\">'Submit'</span></span> <span class=\"token keyword\">unless</span> js<span class=\"token operator\">?</span></code></pre></div>\n<h3 id=\"changing-controllers-to-support-both-modes\" style=\"position:relative;\"><a href=\"#changing-controllers-to-support-both-modes\" aria-label=\"changing controllers to support both modes permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Changing controllers to support both modes</h3>\n<p>We can also have the same rails code support different <em>navigations</em> with or without javascript. This is where Turbo comes in handy.</p>\n<p>Let’s talk about comments. It’s pretty standard to have an inline reply form appearing underneath the comment when a user clicks “reply”. This can only be done with JavaScript. Let’s call it “Reddit style” comments.</p>\n<div class=\"image-frame\" style=\"text-align: left\">\n  <div class=\"image-frame-image\"><gif-player gif=\"reddit-comments.gif\" width=\"350\" /></gif-player></div>\n  <div class=\"image-frame-caption\">Reddit style comments</div>\n</div>\n<p>Then there is Hacker News. Their version of leaving a comment is majestically simple: new page with a form and a submit button. No JavaScript required.</p>\n<div class=\"image-frame\" style=\"text-align: left\">\n  <div class=\"image-frame-image\"><gif-player gif=\"hn-comments.gif\" width=\"350\" /></gif-player></div>\n  <div class=\"image-frame-caption\">HN style comments</div>\n</div>\n<p>Note how the url stays the same on reddit versus visiting the “new comment” page and then going back to the post page on hackernews.</p>\n<p>Now let’s say your site must have “Reddit style” comments for whatever reason. Can we test them without javascript? The answer is yes, because Turbo lets us implement it without a single line of Javascript and in such way that it falls back to “HN style” almost for free.</p>\n<p>Let’s have a look at the implementation.</p>\n<p>“Reply” link renders a new comment form. It is implemented as a standard rails CRUD with the following routes:</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\">  resources <span class=\"token symbol\">:comments</span><span class=\"token punctuation\">,</span> <span class=\"token symbol\">only</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token keyword\">do</span>\n    resources <span class=\"token symbol\">:comments</span>\n  <span class=\"token keyword\">end</span></code></pre></div>\n<p>With the above routes reply link looks like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\"><span class=\"token operator\">&lt;</span><span class=\"token operator\">%=</span> link_to <span class=\"token string-literal\"><span class=\"token string\">'Reply'</span></span><span class=\"token punctuation\">,</span> new_comment_comment_path<span class=\"token punctuation\">(</span>comment<span class=\"token punctuation\">)</span> <span class=\"token operator\">%</span><span class=\"token operator\">></span></code></pre></div>\n<p>And the controller is pretty standard too:</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\"><span class=\"token keyword\">def</span> <span class=\"token method-definition\"><span class=\"token function\">new</span></span>\n  <span class=\"token variable\">@comment</span> <span class=\"token operator\">=</span> <span class=\"token variable\">@commentable</span><span class=\"token punctuation\">.</span>comments<span class=\"token punctuation\">.</span><span class=\"token keyword\">new</span>\n<span class=\"token keyword\">end</span></code></pre></div>\n<p>Now the <code class=\"language-text\">comments/new.html.erb</code> gets some new magic:</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\"><span class=\"token operator\">&lt;</span>h1<span class=\"token operator\">></span>New Comment<span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>h1<span class=\"token operator\">></span>\n\n<span class=\"token operator\">&lt;</span><span class=\"token operator\">%=</span> turbo_frame_tag <span class=\"token string-literal\"><span class=\"token string\">\"new_</span><span class=\"token interpolation\"><span class=\"token delimiter punctuation\">#{</span><span class=\"token content\">dom_id<span class=\"token punctuation\">(</span><span class=\"token variable\">@commentable</span><span class=\"token punctuation\">)</span></span><span class=\"token delimiter punctuation\">}</span></span><span class=\"token string\">_comment\"</span></span> <span class=\"token keyword\">do</span> <span class=\"token string-literal\"><span class=\"token string\">%>\n  &lt;%= render 'form', comment: @comment %></span></span>\n<span class=\"token operator\">&lt;</span><span class=\"token operator\">%</span> <span class=\"token keyword\">end</span> <span class=\"token operator\">%</span><span class=\"token operator\">></span></code></pre></div>\n<p>The peculiar <code class=\"language-text\">turbo_frame_tag</code> does nothing on its own. However, if the part of the page from where “Reply” link was clicked is <em>also</em> wrapped in <code class=\"language-text\">turbo_frame_tag</code> with the same id, then, instead of performing navigation, Turbo js will replace the contents of the outer frame with the contents of the this one.</p>\n<p>So let’s introduce an outer frame by wrapping the “Reply” link (in <code class=\"language-text\">_comment.html.erb</code> partial) with a matching frame. As a result, clicking “Reply” will replace the link with the new comment form, without navigating away from the comments index:</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\"><span class=\"token operator\">&lt;</span><span class=\"token operator\">%=</span> turbo_frame_tag <span class=\"token string-literal\"><span class=\"token string\">\"new_</span><span class=\"token interpolation\"><span class=\"token delimiter punctuation\">#{</span><span class=\"token content\">dom_id<span class=\"token punctuation\">(</span>comment<span class=\"token punctuation\">)</span></span><span class=\"token delimiter punctuation\">}</span></span><span class=\"token string\">_comment\"</span></span> <span class=\"token keyword\">do</span> <span class=\"token string-literal\"><span class=\"token string\">%>\n  &lt;%= link_to 'Reply', new_comment_comment_path(comment) %></span></span>\n<span class=\"token operator\">&lt;</span><span class=\"token operator\">%</span> <span class=\"token keyword\">end</span> <span class=\"token operator\">%</span><span class=\"token operator\">></span></code></pre></div>\n<p>The form itself is a bog standard Rails one:</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\"><span class=\"token operator\">&lt;</span><span class=\"token operator\">%=</span> form_with<span class=\"token punctuation\">(</span><span class=\"token symbol\">model</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>comment<span class=\"token punctuation\">.</span>commentable<span class=\"token punctuation\">,</span> comment<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">do</span> <span class=\"token operator\">|</span>form<span class=\"token operator\">|</span> <span class=\"token operator\">%</span><span class=\"token operator\">></span>\n  <span class=\"token operator\">...</span></code></pre></div>\n<p>It posts to the comments controller that in itself is rather conventional apart from one line:</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\"><span class=\"token keyword\">def</span> <span class=\"token method-definition\"><span class=\"token function\">create</span></span>\n  <span class=\"token variable\">@comment</span> <span class=\"token operator\">=</span> <span class=\"token variable\">@commentable</span><span class=\"token punctuation\">.</span>comments<span class=\"token punctuation\">.</span>build<span class=\"token punctuation\">(</span>comment_params<span class=\"token punctuation\">)</span>\n\n  respond_to <span class=\"token keyword\">do</span> <span class=\"token operator\">|</span>format<span class=\"token operator\">|</span>\n    <span class=\"token keyword\">if</span> <span class=\"token variable\">@comment</span><span class=\"token punctuation\">.</span>save\n      format<span class=\"token punctuation\">.</span>html <span class=\"token punctuation\">{</span> redirect_to <span class=\"token punctuation\">[</span><span class=\"token variable\">@commentable</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">@comment</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token symbol\">notice</span><span class=\"token operator\">:</span> <span class=\"token string-literal\"><span class=\"token string\">'Comment was successfully created.'</span></span> <span class=\"token punctuation\">}</span>\n      format<span class=\"token punctuation\">.</span>turbo_stream <span class=\"token comment\"># &lt;-- turbo magic here!</span>\n    <span class=\"token keyword\">else</span>\n      format<span class=\"token punctuation\">.</span>html <span class=\"token punctuation\">{</span> render <span class=\"token symbol\">:new</span><span class=\"token punctuation\">,</span> <span class=\"token symbol\">status</span><span class=\"token operator\">:</span> <span class=\"token symbol\">:unprocessable_entity</span> <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">end</span>\n  <span class=\"token keyword\">end</span>\n<span class=\"token keyword\">end</span></code></pre></div>\n<p>If the form was submitted via turbo, then the controller will attempt to render <code class=\"language-text\">app/views/comments/create.turbo_stream.erb</code> template. In our case it contains just this one line:</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\"><span class=\"token operator\">&lt;</span><span class=\"token operator\">%=</span> turbo_stream<span class=\"token punctuation\">.</span>replace dom_id<span class=\"token punctuation\">(</span><span class=\"token variable\">@commentable</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">@commentable</span> <span class=\"token operator\">%</span><span class=\"token operator\">></span></code></pre></div>\n<p>Which is a DSL for “find an element on the page with <code class=\"language-text\">dom_id(@commentable)</code> and replace it with rendered <code class=\"language-text\">@commentable</code>”. This updates comment’s <em>parent</em>, which naturally contains newly created comment <em>and</em> gets rid of the form. For this to work each comment on a page must be wrapped in a container with its <code class=\"language-text\">dom_id</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\"><span class=\"token operator\">&lt;</span><span class=\"token operator\">%=</span> tag<span class=\"token punctuation\">.</span>div id<span class=\"token operator\">:</span> dom_id<span class=\"token punctuation\">(</span>comment<span class=\"token punctuation\">)</span> <span class=\"token keyword\">do</span> <span class=\"token string-literal\"><span class=\"token string\">%>\n  &lt;div></span></span>\n    <span class=\"token operator\">&lt;</span><span class=\"token operator\">%=</span> comment<span class=\"token punctuation\">.</span>body <span class=\"token string-literal\"><span class=\"token string\">%>\n  &lt;/div></span></span>\n\n  <span class=\"token operator\">&lt;</span>div<span class=\"token operator\">></span>\n    <span class=\"token operator\">&lt;</span><span class=\"token operator\">%=</span> comment<span class=\"token punctuation\">.</span>created_at <span class=\"token string-literal\"><span class=\"token string\">%> |\n    &lt;%= turbo_frame_tag \"new_</span><span class=\"token interpolation\"><span class=\"token delimiter punctuation\">#{</span><span class=\"token content\">dom_id<span class=\"token punctuation\">(</span>comment<span class=\"token punctuation\">)</span></span><span class=\"token delimiter punctuation\">}</span></span><span class=\"token string\">_comment\" do %></span></span>\n      <span class=\"token operator\">&lt;</span><span class=\"token operator\">%=</span> link_to <span class=\"token string-literal\"><span class=\"token string\">'Reply'</span></span><span class=\"token punctuation\">,</span> new_comment_comment_path<span class=\"token punctuation\">(</span>comment<span class=\"token punctuation\">)</span> <span class=\"token string-literal\"><span class=\"token string\">%>\n    &lt;% end %></span></span>\n  <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>div<span class=\"token operator\">></span>\n\n  <span class=\"token operator\">&lt;</span>div<span class=\"token operator\">></span>\n    <span class=\"token operator\">&lt;</span><span class=\"token operator\">%=</span> render comment<span class=\"token punctuation\">.</span>comments <span class=\"token string-literal\"><span class=\"token string\">%>\n  &lt;/div></span></span>\n<span class=\"token operator\">&lt;</span><span class=\"token operator\">%</span> <span class=\"token keyword\">end</span> <span class=\"token operator\">%</span><span class=\"token operator\">></span></code></pre></div>\n<p>Now, just like in the case of rendering reply form, this is functionally equivalent to the non-js version, but the presentation is different.</p>\n<p>Putting all of the above together, replying to a comment works “Reddit style” with Javascript enabled and falls back to “HN style” otherwise. And so the following system test runs both with <code class=\"language-text\">selenium</code> and <code class=\"language-text\">rack_test</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\">test <span class=\"token string-literal\"><span class=\"token string\">'replying to a comment'</span></span> <span class=\"token keyword\">do</span>\n  post <span class=\"token operator\">=</span> posts<span class=\"token punctuation\">(</span><span class=\"token symbol\">:one</span><span class=\"token punctuation\">)</span>\n\n  visit post_path<span class=\"token punctuation\">(</span>post<span class=\"token punctuation\">)</span>\n\n  click_link <span class=\"token string-literal\"><span class=\"token string\">'Reply'</span></span><span class=\"token punctuation\">,</span> <span class=\"token symbol\">match</span><span class=\"token operator\">:</span> <span class=\"token symbol\">:first</span>\n  fill_in <span class=\"token string-literal\"><span class=\"token string\">'Body'</span></span><span class=\"token punctuation\">,</span> <span class=\"token symbol\">with</span><span class=\"token operator\">:</span> <span class=\"token string-literal\"><span class=\"token string\">'Bananas'</span></span>\n  click_on <span class=\"token string-literal\"><span class=\"token string\">'Create Comment'</span></span>\n\n  assert_text <span class=\"token string-literal\"><span class=\"token string\">'Comment was successfully created'</span></span> <span class=\"token keyword\">unless</span> js<span class=\"token operator\">?</span>\n  assert_text <span class=\"token string-literal\"><span class=\"token string\">'Bananas'</span></span>\n<span class=\"token keyword\">end</span></code></pre></div>\n<h3 id=\"going-further\" style=\"position:relative;\"><a href=\"#going-further\" aria-label=\"going further permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Going further</h3>\n<p>The reason we were able to pull the “reply to comment” trick is that Turbo allows us to implement SPA behavior without writing any Javascript. But there are of course limits to what client side experience can be implemented without Javascript.</p>\n<p>This is where you might want to check out <a href=\"https://stimulus.hotwired.dev/\" target=\"_blank\" rel=\"nofollow\">Stimulus</a>. It has many qualities, but the one that’s relevant to this post is that Stimululs does not attempt to render html, but merely adds behvavior to the <em>existing</em> (server side rendered) html. And that naturally makes it easier to design solutions that fallback to non-js version.</p>\n<p>Check out the previous (pre Turbo) <a href=\"https://featurist.co.uk/blog/progressive-enhancement-in-rails/\" target=\"_blank\" rel=\"nofollow\">version</a> of this post, where Reddit/HN example is implemented using Turbolinks, UJS and Stimulus to see the example of this.</p>\n<h2 id=\"conclusion\" style=\"position:relative;\"><a href=\"#conclusion\" aria-label=\"conclusion permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Conclusion</h2>\n<p>Rails allows us to build rich client side UIs without writing a lot of Javascript. This, coupled with support for Progressive Enhancement and <code class=\"language-text\">rack_test</code>, provides an opportunity to reduce the reliance on browser tests. Which is a good thing because browser tests are slow and hard to work with.</p>\n<p>All the code snippets above are working. Go ahead and check out the <a href=\"https://github.com/artemave/rails-testing-post\" target=\"_blank\" rel=\"nofollow\">example repo</a> and see it in action on <a href=\"https://turbo-and-fast-system-tests.herokuapp.com/\" target=\"_blank\" rel=\"nofollow\">heroku</a> (“Disable JavaScript” in devtools for non-JS version).</p>","htmlAst":{"type":"root","children":[{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Rails allows us to build rich UIs without writing Javascript. Rails also allows us to test those UIs without an actual browser."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"This post is focused on that last capability. And on how "},{"type":"element","tagName":"a","properties":{"href":"https://turbo.hotwired.dev/","target":"_blank","rel":["nofollow"]},"children":[{"type":"text","value":"Turbo"}]},{"type":"text","value":" extends it even further."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"But before we begin let’s take a look into why testing UIs without browser is something worth doing. Feel free to "},{"type":"element","tagName":"a","properties":{"href":"#rails-system-tests"},"children":[{"type":"text","value":"skip over"}]},{"type":"text","value":" the next part if you must see the code "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"now"}]},{"type":"text","value":"."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h2","properties":{"id":"browser-testing","style":"position:relative;"},"children":[{"type":"element","tagName":"a","properties":{"href":"#browser-testing","ariaLabel":"browser testing permalink","className":["anchor","before"]},"children":[{"type":"element","tagName":"svg","properties":{"ariaHidden":"true","focusable":"false","height":"16","version":"1.1","viewBox":"0 0 16 16","width":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"},"children":[]}]}]},{"type":"text","value":"Browser testing"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{"id":"problem","style":"position:relative;"},"children":[{"type":"element","tagName":"a","properties":{"href":"#problem","ariaLabel":"problem permalink","className":["anchor","before"]},"children":[{"type":"element","tagName":"svg","properties":{"ariaHidden":"true","focusable":"false","height":"16","version":"1.1","viewBox":"0 0 16 16","width":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"},"children":[]}]}]},{"type":"text","value":"Problem"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Rails system tests are slow (compared to model and controller tests) because they drive the application via real browser. This affects both start up and execution times. In addition to being slow, browser tests are harder to debug because the state of the app is spread across two independent processes: ruby server and browser client."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{"id":"alternative","style":"position:relative;"},"children":[{"type":"element","tagName":"a","properties":{"href":"#alternative","ariaLabel":"alternative permalink","className":["anchor","before"]},"children":[{"type":"element","tagName":"svg","properties":{"ariaHidden":"true","focusable":"false","height":"16","version":"1.1","viewBox":"0 0 16 16","width":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"},"children":[]}]}]},{"type":"text","value":"Alternative"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Rails is using Capybara to drive the UI in system tests. Capybara in turn is using "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"selenium"}]},{"type":"text","value":" driver to communicate with the browser. There is, however, another driver called "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"rack_test"}]},{"type":"text","value":". It plugs Capybara directly into the request middleware stack, bypassing the need to actually run the server and open the browser in order to be able to visit urls, click links, submit forms and so on. Effectively, under "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"rack_test"}]},{"type":"text","value":" system tests are using the same underlying machinery as controller tests."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"This is a cool party trick, but this way Capybara will no longer exercise any javascript. Unless our application is "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"somehow"}]},{"type":"text","value":" functional without javascript as well. Sounds like a lot of work, but this is where Rails has a few tricks to offer. And even more so with the advent of Turbo."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Rails sticks to server-side rendering and progressive enhancement (PE). The latter is what allows our application to function without javascript. So far PE in Rails was supported by "},{"type":"element","tagName":"a","properties":{"href":"https://guides.rubyonrails.org/working_with_javascript_in_rails.html#turbolinks","target":"_blank","rel":["nofollow"]},"children":[{"type":"text","value":"Turbolinks"}]},{"type":"text","value":" and "},{"type":"element","tagName":"a","properties":{"href":"https://guides.rubyonrails.org/working_with_javascript_in_rails.html#unobtrusive-javascript","target":"_blank","rel":["nofollow"]},"children":[{"type":"text","value":"UJS"}]},{"type":"text","value":", but that, without going into details, was a fairly basic tech."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Now meet "},{"type":"element","tagName":"a","properties":{"href":"https://turbo.hotwired.dev/","target":"_blank","rel":["nofollow"]},"children":[{"type":"text","value":"Turbo"}]},{"type":"text","value":", part of the "},{"type":"element","tagName":"a","properties":{"href":"https://hotwired.dev/","target":"_blank","rel":["nofollow"]},"children":[{"type":"text","value":"Hotwire"}]},{"type":"text","value":" family. Turbo has "},{"type":"element","tagName":"a","properties":{"href":"https://turbo.hotwired.dev/handbook/drive","target":"_blank","rel":["nofollow"]},"children":[{"type":"text","value":"Drive"}]},{"type":"text","value":", which is just a more polished, streamlined version of what was already largely possible with Turbolinks + UJS. It also has "},{"type":"element","tagName":"a","properties":{"href":"https://turbo.hotwired.dev/handbook/frames","target":"_blank","rel":["nofollow"]},"children":[{"type":"text","value":"Frames"}]},{"type":"text","value":". Frames is a brand new capability that allows you to update parts of the page independently. Finally there are "},{"type":"element","tagName":"a","properties":{"href":"https://turbo.hotwired.dev/handbook/streams","target":"_blank","rel":["nofollow"]},"children":[{"type":"text","value":"Streams"}]},{"type":"text","value":", another addition that provides a DSL for “gluing” bits of server side rendered html into the dom on the client side."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"All the while sticking to server side rendering only. And if everything is rendered by rails controllers, then switching to "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"rack_test"}]},{"type":"text","value":" doesn’t actually sound like a big deal."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"It’s important to note that the end game is not to replace "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"selenium"}]},{"type":"text","value":" with "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"rack_test"}]},{"type":"text","value":", but to be able to run the same tests in "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"both"}]},{"type":"text","value":" modes. "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"rack_test"}]},{"type":"text","value":" for speed and ease of debugging, followed by "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"selenium"}]},{"type":"text","value":" for the ultimate confidence."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"With that in mind, let’s see what it takes to achieve this in practice."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h2","properties":{"id":"rails-system-tests","style":"position:relative;"},"children":[{"type":"element","tagName":"a","properties":{"href":"#rails-system-tests","ariaLabel":"rails system tests permalink","className":["anchor","before"]},"children":[{"type":"element","tagName":"svg","properties":{"ariaHidden":"true","focusable":"false","height":"16","version":"1.1","viewBox":"0 0 16 16","width":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"},"children":[]}]}]},{"type":"text","value":"Rails system tests"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Out of the box, Rails 6/7 system tests pop up a Chrome browser ("},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"test/application_system_test_case.rb"}]},{"type":"text","value":"):"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"ruby"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-ruby"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-ruby"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"require"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string-literal"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"test_helper\""}]}]},{"type":"text","value":"\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"class"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","class-name"]},"children":[{"type":"text","value":"ApplicationSystemTestCase"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"<"}]},{"type":"text","value":" ActionDispatch"},{"type":"element","tagName":"span","properties":{"className":["token","double-colon","punctuation"]},"children":[{"type":"text","value":"::"}]},{"type":"text","value":"SystemTestCase\n  driven_by "},{"type":"element","tagName":"span","properties":{"className":["token","symbol"]},"children":[{"type":"text","value":":selenium"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":","}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","symbol"]},"children":[{"type":"text","value":"using"}]},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","symbol"]},"children":[{"type":"text","value":":chrome"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":","}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","symbol"]},"children":[{"type":"text","value":"screen_size"}]},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"["}]},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"1400"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":","}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"1400"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"]"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"end"}]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{"id":"going-headless","style":"position:relative;"},"children":[{"type":"element","tagName":"a","properties":{"href":"#going-headless","ariaLabel":"going headless permalink","className":["anchor","before"]},"children":[{"type":"element","tagName":"svg","properties":{"ariaHidden":"true","focusable":"false","height":"16","version":"1.1","viewBox":"0 0 16 16","width":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"},"children":[]}]}]},{"type":"text","value":"Going headless"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"The browser window flashing is a distraction so the first thing to do is to switch to headless mode by default (rails also registers "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":":headless_chrome"}]},{"type":"text","value":" driver):"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"ruby"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-ruby"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-ruby"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"require"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string-literal"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"'test_helper'"}]}]},{"type":"text","value":"\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"class"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","class-name"]},"children":[{"type":"text","value":"ApplicationSystemTestCase"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"<"}]},{"type":"text","value":" ActionDispatch"},{"type":"element","tagName":"span","properties":{"className":["token","double-colon","punctuation"]},"children":[{"type":"text","value":"::"}]},{"type":"text","value":"SystemTestCase\n  driven_by "},{"type":"element","tagName":"span","properties":{"className":["token","symbol"]},"children":[{"type":"text","value":":selenium"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":","}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","symbol"]},"children":[{"type":"text","value":"using"}]},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","constant"]},"children":[{"type":"text","value":"ENV"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"["}]},{"type":"element","tagName":"span","properties":{"className":["token","string-literal"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"'GUI'"}]}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"]"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"?"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","symbol"]},"children":[{"type":"text","value":":chrome"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","symbol"]},"children":[{"type":"text","value":":headless_chrome"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"end"}]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"The original GUI version can be turned on with an environment variable: "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"GUI=1 rails test:system"}]},{"type":"text","value":". As a bonus, headless tests are slightly faster."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{"id":"rack_test","style":"position:relative;"},"children":[{"type":"element","tagName":"a","properties":{"href":"#rack_test","ariaLabel":"rack_test permalink","className":["anchor","before"]},"children":[{"type":"element","tagName":"svg","properties":{"ariaHidden":"true","focusable":"false","height":"16","version":"1.1","viewBox":"0 0 16 16","width":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"},"children":[]}]}]},{"type":"text","value":"rack_test"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Now let’s go for full glory. "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"rails test:system"}]},{"type":"text","value":" is going to run purely in ruby. "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"JS=1 rails test:system"}]},{"type":"text","value":" will run in a headless browser and "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"GUI=1 rails test:system"}]},{"type":"text","value":" will open a regular browser."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"ruby"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-ruby"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-ruby"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"class"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","class-name"]},"children":[{"type":"text","value":"ApplicationSystemTestCase"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"<"}]},{"type":"text","value":" ActionDispatch"},{"type":"element","tagName":"span","properties":{"className":["token","double-colon","punctuation"]},"children":[{"type":"text","value":"::"}]},{"type":"text","value":"SystemTestCase\n  "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"def"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","method-definition"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"self"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"."}]},{"type":"element","tagName":"span","properties":{"className":["token","function"]},"children":[{"type":"text","value":"js"}]}]},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"?"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","constant"]},"children":[{"type":"text","value":"ENV"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"["}]},{"type":"element","tagName":"span","properties":{"className":["token","string-literal"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"'JS'"}]}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"]"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"||"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","constant"]},"children":[{"type":"text","value":"ENV"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"["}]},{"type":"element","tagName":"span","properties":{"className":["token","string-literal"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"'GUI'"}]}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"]"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"end"}]},{"type":"text","value":"\n\n  "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"if"}]},{"type":"text","value":" js"},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"?"}]},{"type":"text","value":"\n    driven_by "},{"type":"element","tagName":"span","properties":{"className":["token","symbol"]},"children":[{"type":"text","value":":selenium"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":","}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","symbol"]},"children":[{"type":"text","value":"using"}]},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","constant"]},"children":[{"type":"text","value":"ENV"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"["}]},{"type":"element","tagName":"span","properties":{"className":["token","string-literal"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"'GUI'"}]}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"]"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"?"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","symbol"]},"children":[{"type":"text","value":":chrome"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","symbol"]},"children":[{"type":"text","value":":headless_chrome"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"else"}]},{"type":"text","value":"\n    driven_by "},{"type":"element","tagName":"span","properties":{"className":["token","symbol"]},"children":[{"type":"text","value":":rack_test"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"end"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"end"}]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"br","properties":{},"children":[]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"em","properties":{},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"rack_test"}]},{"type":"text","value":" ships with Capybara by default, no need to install extra gems."}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h2","properties":{"id":"dealing-with-javascript","style":"position:relative;"},"children":[{"type":"element","tagName":"a","properties":{"href":"#dealing-with-javascript","ariaLabel":"dealing with javascript permalink","className":["anchor","before"]},"children":[{"type":"element","tagName":"svg","properties":{"ariaHidden":"true","focusable":"false","height":"16","version":"1.1","viewBox":"0 0 16 16","width":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"},"children":[]}]}]},{"type":"text","value":"Dealing with Javascript"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Now that we can run system tests in ruby, let’s see what can be done about JavaScript powered features that can’t be tested with "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"rack_test"}]},{"type":"text","value":"."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{"id":"opting-out-of-rack_test","style":"position:relative;"},"children":[{"type":"element","tagName":"a","properties":{"href":"#opting-out-of-rack_test","ariaLabel":"opting out of rack_test permalink","className":["anchor","before"]},"children":[{"type":"element","tagName":"svg","properties":{"ariaHidden":"true","focusable":"false","height":"16","version":"1.1","viewBox":"0 0 16 16","width":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"},"children":[]}]}]},{"type":"text","value":"Opting out of rack_test"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Some features are more client side than others (for example, embedded payment iframe) to the point that it does not make sense to have a "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"rack_test"}]},{"type":"text","value":" version. In this case, you can simply wrap related tests in "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"if js?"}]},{"type":"text","value":" to make them only run in the real browser."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Or you can opt out of "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"rack_test"}]},{"type":"text","value":" by default and gradually add existing tests in as and when to avoid “all or nothing” upgrade."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{"id":"changing-tests-to-support-both-modes","style":"position:relative;"},"children":[{"type":"element","tagName":"a","properties":{"href":"#changing-tests-to-support-both-modes","ariaLabel":"changing tests to support both modes permalink","className":["anchor","before"]},"children":[{"type":"element","tagName":"svg","properties":{"ariaHidden":"true","focusable":"false","height":"16","version":"1.1","viewBox":"0 0 16 16","width":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"},"children":[]}]}]},{"type":"text","value":"Changing tests to support both modes"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"While it makes sense in some cases, excluding tests from "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"rack_test"}]},{"type":"text","value":" defeats the whole point. Sometimes the difference between javascript and non-js versions is cosmetic and can be captured in a test helper. That’s a low hanging fruit.\nFor example, javascript confirm dialog only exists in the actual browser. We can make a helper method that will confirm the dialog when the test runs in javascript or otherwise do nothing:"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"ruby"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-ruby"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-ruby"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"def"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","method-definition"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","function"]},"children":[{"type":"text","value":"confirm"}]}]},{"type":"text","value":"\n  js"},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"?"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"?"}]},{"type":"text","value":" accept_confirm "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"{"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"yield"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"}"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"yield"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"end"}]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"And then somewhere in the test:"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"ruby"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-ruby"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-ruby"]},"children":[{"type":"text","value":"confirm "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"{"}]},{"type":"text","value":" click_button "},{"type":"element","tagName":"span","properties":{"className":["token","string-literal"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"'Destroy'"}]}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"}"}]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Naturally, you’ll find yourself minimizing the differences between javascript and non-js versions of your site and that is actually good thing."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{"id":"changing-views-to-support-both-modes","style":"position:relative;"},"children":[{"type":"element","tagName":"a","properties":{"href":"#changing-views-to-support-both-modes","ariaLabel":"changing views to support both modes permalink","className":["anchor","before"]},"children":[{"type":"element","tagName":"svg","properties":{"ariaHidden":"true","focusable":"false","height":"16","version":"1.1","viewBox":"0 0 16 16","width":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"},"children":[]}]}]},{"type":"text","value":"Changing views to support both modes"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Imagine a form with a single checkbox that automatically submits whenever checkbox is toggled. This can only be done in JavaScript. For the non-JS version we can add a “Submit” button that is only shown when the form page is viewed without JavaScript."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"There is a clever trick to support this kind of extra non-JS controls. Add the following to the top layout file:"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"html"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-html"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-html"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","tag"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","tag"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"<"}]},{"type":"text","value":"html"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","attr-name"]},"children":[{"type":"text","value":"class"}]},{"type":"element","tagName":"span","properties":{"className":["token","attr-value"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","punctuation","attr-equals"]},"children":[{"type":"text","value":"="}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"\""}]},{"type":"text","value":"no-js"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"\""}]}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":">"}]}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","tag"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","tag"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"<"}]},{"type":"text","value":"head"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":">"}]}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","tag"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","tag"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"<"}]},{"type":"text","value":"style"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":">"}]}]},{"type":"element","tagName":"span","properties":{"className":["token","style"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","language-css"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","selector"]},"children":[{"type":"text","value":".js .js-hidden"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"{"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","property"]},"children":[{"type":"text","value":"display"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" none"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":";"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"}"}]}]}]},{"type":"element","tagName":"span","properties":{"className":["token","tag"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","tag"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"</"}]},{"type":"text","value":"style"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":">"}]}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","tag"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","tag"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"<"}]},{"type":"text","value":"script"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":">"}]}]},{"type":"element","tagName":"span","properties":{"className":["token","script"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","language-javascript"]},"children":[{"type":"text","value":"document"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"."}]},{"type":"text","value":"documentElement"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"."}]},{"type":"text","value":"className "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"="}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"'js'"}]}]}]},{"type":"element","tagName":"span","properties":{"className":["token","tag"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","tag"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"</"}]},{"type":"text","value":"script"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":">"}]}]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"When JavaScript is enabled, the script will replace top element class name from "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"no-js"}]},{"type":"text","value":" to "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"js"}]},{"type":"text","value":", thus activating the "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":".js-hidden"}]},{"type":"text","value":" CSS rule. Now we can add "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"js-hidden"}]},{"type":"text","value":" class to the submit button (or indeed anything that we don’t want regular users to see):"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"ruby"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-ruby"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-ruby"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"<"}]},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"%="}]},{"type":"text","value":" f"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"."}]},{"type":"text","value":"submit"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":","}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","symbol"]},"children":[{"type":"text","value":"class"}]},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string-literal"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"'js-hidden'"}]}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"%"}]},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":">"}]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Then in tests:"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"ruby"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-ruby"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-ruby"]},"children":[{"type":"text","value":"click_button "},{"type":"element","tagName":"span","properties":{"className":["token","string-literal"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"'Submit'"}]}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"unless"}]},{"type":"text","value":" js"},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"?"}]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{"id":"changing-controllers-to-support-both-modes","style":"position:relative;"},"children":[{"type":"element","tagName":"a","properties":{"href":"#changing-controllers-to-support-both-modes","ariaLabel":"changing controllers to support both modes permalink","className":["anchor","before"]},"children":[{"type":"element","tagName":"svg","properties":{"ariaHidden":"true","focusable":"false","height":"16","version":"1.1","viewBox":"0 0 16 16","width":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"},"children":[]}]}]},{"type":"text","value":"Changing controllers to support both modes"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"We can also have the same rails code support different "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"navigations"}]},{"type":"text","value":" with or without javascript. This is where Turbo comes in handy."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Let’s talk about comments. It’s pretty standard to have an inline reply form appearing underneath the comment when a user clicks “reply”. This can only be done with JavaScript. Let’s call it “Reddit style” comments."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["image-frame"],"style":"text-align: left"},"children":[{"type":"text","value":"\n  "},{"type":"element","tagName":"div","properties":{"className":["image-frame-image"]},"children":[{"type":"element","tagName":"gif-player","properties":{"gif":"reddit-comments.gif","width":350},"children":[]}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"div","properties":{"className":["image-frame-caption"]},"children":[{"type":"text","value":"Reddit style comments"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Then there is Hacker News. Their version of leaving a comment is majestically simple: new page with a form and a submit button. No JavaScript required."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["image-frame"],"style":"text-align: left"},"children":[{"type":"text","value":"\n  "},{"type":"element","tagName":"div","properties":{"className":["image-frame-image"]},"children":[{"type":"element","tagName":"gif-player","properties":{"gif":"hn-comments.gif","width":350},"children":[]}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"div","properties":{"className":["image-frame-caption"]},"children":[{"type":"text","value":"HN style comments"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Note how the url stays the same on reddit versus visiting the “new comment” page and then going back to the post page on hackernews."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Now let’s say your site must have “Reddit style” comments for whatever reason. Can we test them without javascript? The answer is yes, because Turbo lets us implement it without a single line of Javascript and in such way that it falls back to “HN style” almost for free."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Let’s have a look at the implementation."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"“Reply” link renders a new comment form. It is implemented as a standard rails CRUD with the following routes:"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"ruby"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-ruby"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-ruby"]},"children":[{"type":"text","value":"  resources "},{"type":"element","tagName":"span","properties":{"className":["token","symbol"]},"children":[{"type":"text","value":":comments"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":","}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","symbol"]},"children":[{"type":"text","value":"only"}]},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"["}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"]"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"do"}]},{"type":"text","value":"\n    resources "},{"type":"element","tagName":"span","properties":{"className":["token","symbol"]},"children":[{"type":"text","value":":comments"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"end"}]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"With the above routes reply link looks like this:"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"ruby"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-ruby"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-ruby"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"<"}]},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"%="}]},{"type":"text","value":" link_to "},{"type":"element","tagName":"span","properties":{"className":["token","string-literal"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"'Reply'"}]}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":","}]},{"type":"text","value":" new_comment_comment_path"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"("}]},{"type":"text","value":"comment"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":")"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"%"}]},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":">"}]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"And the controller is pretty standard too:"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"ruby"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-ruby"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-ruby"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"def"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","method-definition"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","function"]},"children":[{"type":"text","value":"new"}]}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","variable"]},"children":[{"type":"text","value":"@comment"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"="}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","variable"]},"children":[{"type":"text","value":"@commentable"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"."}]},{"type":"text","value":"comments"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"."}]},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"new"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"end"}]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Now the "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"comments/new.html.erb"}]},{"type":"text","value":" gets some new magic:"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"ruby"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-ruby"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-ruby"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"<"}]},{"type":"text","value":"h1"},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":">"}]},{"type":"text","value":"New Comment"},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"<"}]},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"/"}]},{"type":"text","value":"h1"},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":">"}]},{"type":"text","value":"\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"<"}]},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"%="}]},{"type":"text","value":" turbo_frame_tag "},{"type":"element","tagName":"span","properties":{"className":["token","string-literal"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"new_"}]},{"type":"element","tagName":"span","properties":{"className":["token","interpolation"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","delimiter","punctuation"]},"children":[{"type":"text","value":"#{"}]},{"type":"element","tagName":"span","properties":{"className":["token","content"]},"children":[{"type":"text","value":"dom_id"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"("}]},{"type":"element","tagName":"span","properties":{"className":["token","variable"]},"children":[{"type":"text","value":"@commentable"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":")"}]}]},{"type":"element","tagName":"span","properties":{"className":["token","delimiter","punctuation"]},"children":[{"type":"text","value":"}"}]}]},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"_comment\""}]}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"do"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string-literal"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"%>\n  <%= render 'form', comment: @comment %>"}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"<"}]},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"%"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"end"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"%"}]},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":">"}]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"The peculiar "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"turbo_frame_tag"}]},{"type":"text","value":" does nothing on its own. However, if the part of the page from where “Reply” link was clicked is "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"also"}]},{"type":"text","value":" wrapped in "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"turbo_frame_tag"}]},{"type":"text","value":" with the same id, then, instead of performing navigation, Turbo js will replace the contents of the outer frame with the contents of the this one."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"So let’s introduce an outer frame by wrapping the “Reply” link (in "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"_comment.html.erb"}]},{"type":"text","value":" partial) with a matching frame. As a result, clicking “Reply” will replace the link with the new comment form, without navigating away from the comments index:"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"ruby"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-ruby"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-ruby"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"<"}]},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"%="}]},{"type":"text","value":" turbo_frame_tag "},{"type":"element","tagName":"span","properties":{"className":["token","string-literal"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"new_"}]},{"type":"element","tagName":"span","properties":{"className":["token","interpolation"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","delimiter","punctuation"]},"children":[{"type":"text","value":"#{"}]},{"type":"element","tagName":"span","properties":{"className":["token","content"]},"children":[{"type":"text","value":"dom_id"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"("}]},{"type":"text","value":"comment"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":")"}]}]},{"type":"element","tagName":"span","properties":{"className":["token","delimiter","punctuation"]},"children":[{"type":"text","value":"}"}]}]},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"_comment\""}]}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"do"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string-literal"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"%>\n  <%= link_to 'Reply', new_comment_comment_path(comment) %>"}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"<"}]},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"%"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"end"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"%"}]},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":">"}]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"The form itself is a bog standard Rails one:"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"ruby"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-ruby"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-ruby"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"<"}]},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"%="}]},{"type":"text","value":" form_with"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"("}]},{"type":"element","tagName":"span","properties":{"className":["token","symbol"]},"children":[{"type":"text","value":"model"}]},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"["}]},{"type":"text","value":"comment"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"."}]},{"type":"text","value":"commentable"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":","}]},{"type":"text","value":" comment"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"]"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":")"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"do"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"|"}]},{"type":"text","value":"form"},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"|"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"%"}]},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":">"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"..."}]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"It posts to the comments controller that in itself is rather conventional apart from one line:"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"ruby"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-ruby"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-ruby"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"def"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","method-definition"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","function"]},"children":[{"type":"text","value":"create"}]}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","variable"]},"children":[{"type":"text","value":"@comment"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"="}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","variable"]},"children":[{"type":"text","value":"@commentable"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"."}]},{"type":"text","value":"comments"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"."}]},{"type":"text","value":"build"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"("}]},{"type":"text","value":"comment_params"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":")"}]},{"type":"text","value":"\n\n  respond_to "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"do"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"|"}]},{"type":"text","value":"format"},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"|"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"if"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","variable"]},"children":[{"type":"text","value":"@comment"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"."}]},{"type":"text","value":"save\n      format"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"."}]},{"type":"text","value":"html "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"{"}]},{"type":"text","value":" redirect_to "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"["}]},{"type":"element","tagName":"span","properties":{"className":["token","variable"]},"children":[{"type":"text","value":"@commentable"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":","}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","variable"]},"children":[{"type":"text","value":"@comment"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"]"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":","}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","symbol"]},"children":[{"type":"text","value":"notice"}]},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string-literal"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"'Comment was successfully created.'"}]}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"}"}]},{"type":"text","value":"\n      format"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"."}]},{"type":"text","value":"turbo_stream "},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# <-- turbo magic here!"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"else"}]},{"type":"text","value":"\n      format"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"."}]},{"type":"text","value":"html "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"{"}]},{"type":"text","value":" render "},{"type":"element","tagName":"span","properties":{"className":["token","symbol"]},"children":[{"type":"text","value":":new"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":","}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","symbol"]},"children":[{"type":"text","value":"status"}]},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","symbol"]},"children":[{"type":"text","value":":unprocessable_entity"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"}"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"end"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"end"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"end"}]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"If the form was submitted via turbo, then the controller will attempt to render "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"app/views/comments/create.turbo_stream.erb"}]},{"type":"text","value":" template. In our case it contains just this one line:"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"ruby"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-ruby"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-ruby"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"<"}]},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"%="}]},{"type":"text","value":" turbo_stream"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"."}]},{"type":"text","value":"replace dom_id"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"("}]},{"type":"element","tagName":"span","properties":{"className":["token","variable"]},"children":[{"type":"text","value":"@commentable"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":")"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":","}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","variable"]},"children":[{"type":"text","value":"@commentable"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"%"}]},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":">"}]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Which is a DSL for “find an element on the page with "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"dom_id(@commentable)"}]},{"type":"text","value":" and replace it with rendered "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"@commentable"}]},{"type":"text","value":"”. This updates comment’s "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"parent"}]},{"type":"text","value":", which naturally contains newly created comment "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"and"}]},{"type":"text","value":" gets rid of the form. For this to work each comment on a page must be wrapped in a container with its "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"dom_id"}]},{"type":"text","value":":"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"ruby"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-ruby"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-ruby"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"<"}]},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"%="}]},{"type":"text","value":" tag"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"."}]},{"type":"text","value":"div id"},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" dom_id"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"("}]},{"type":"text","value":"comment"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":")"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"do"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string-literal"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"%>\n  <div>"}]}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"<"}]},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"%="}]},{"type":"text","value":" comment"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"."}]},{"type":"text","value":"body "},{"type":"element","tagName":"span","properties":{"className":["token","string-literal"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"%>\n  </div>"}]}]},{"type":"text","value":"\n\n  "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"<"}]},{"type":"text","value":"div"},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":">"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"<"}]},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"%="}]},{"type":"text","value":" comment"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"."}]},{"type":"text","value":"created_at "},{"type":"element","tagName":"span","properties":{"className":["token","string-literal"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"%> |\n    <%= turbo_frame_tag \"new_"}]},{"type":"element","tagName":"span","properties":{"className":["token","interpolation"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","delimiter","punctuation"]},"children":[{"type":"text","value":"#{"}]},{"type":"element","tagName":"span","properties":{"className":["token","content"]},"children":[{"type":"text","value":"dom_id"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"("}]},{"type":"text","value":"comment"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":")"}]}]},{"type":"element","tagName":"span","properties":{"className":["token","delimiter","punctuation"]},"children":[{"type":"text","value":"}"}]}]},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"_comment\" do %>"}]}]},{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"<"}]},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"%="}]},{"type":"text","value":" link_to "},{"type":"element","tagName":"span","properties":{"className":["token","string-literal"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"'Reply'"}]}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":","}]},{"type":"text","value":" new_comment_comment_path"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"("}]},{"type":"text","value":"comment"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":")"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string-literal"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"%>\n    <% end %>"}]}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"<"}]},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"/"}]},{"type":"text","value":"div"},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":">"}]},{"type":"text","value":"\n\n  "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"<"}]},{"type":"text","value":"div"},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":">"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"<"}]},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"%="}]},{"type":"text","value":" render comment"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"."}]},{"type":"text","value":"comments "},{"type":"element","tagName":"span","properties":{"className":["token","string-literal"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"%>\n  </div>"}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"<"}]},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"%"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"end"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"%"}]},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":">"}]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Now, just like in the case of rendering reply form, this is functionally equivalent to the non-js version, but the presentation is different."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Putting all of the above together, replying to a comment works “Reddit style” with Javascript enabled and falls back to “HN style” otherwise. And so the following system test runs both with "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"selenium"}]},{"type":"text","value":" and "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"rack_test"}]},{"type":"text","value":":"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"ruby"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-ruby"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-ruby"]},"children":[{"type":"text","value":"test "},{"type":"element","tagName":"span","properties":{"className":["token","string-literal"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"'replying to a comment'"}]}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"do"}]},{"type":"text","value":"\n  post "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"="}]},{"type":"text","value":" posts"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"("}]},{"type":"element","tagName":"span","properties":{"className":["token","symbol"]},"children":[{"type":"text","value":":one"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":")"}]},{"type":"text","value":"\n\n  visit post_path"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"("}]},{"type":"text","value":"post"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":")"}]},{"type":"text","value":"\n\n  click_link "},{"type":"element","tagName":"span","properties":{"className":["token","string-literal"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"'Reply'"}]}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":","}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","symbol"]},"children":[{"type":"text","value":"match"}]},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","symbol"]},"children":[{"type":"text","value":":first"}]},{"type":"text","value":"\n  fill_in "},{"type":"element","tagName":"span","properties":{"className":["token","string-literal"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"'Body'"}]}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":","}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","symbol"]},"children":[{"type":"text","value":"with"}]},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string-literal"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"'Bananas'"}]}]},{"type":"text","value":"\n  click_on "},{"type":"element","tagName":"span","properties":{"className":["token","string-literal"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"'Create Comment'"}]}]},{"type":"text","value":"\n\n  assert_text "},{"type":"element","tagName":"span","properties":{"className":["token","string-literal"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"'Comment was successfully created'"}]}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"unless"}]},{"type":"text","value":" js"},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"?"}]},{"type":"text","value":"\n  assert_text "},{"type":"element","tagName":"span","properties":{"className":["token","string-literal"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"'Bananas'"}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"end"}]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{"id":"going-further","style":"position:relative;"},"children":[{"type":"element","tagName":"a","properties":{"href":"#going-further","ariaLabel":"going further permalink","className":["anchor","before"]},"children":[{"type":"element","tagName":"svg","properties":{"ariaHidden":"true","focusable":"false","height":"16","version":"1.1","viewBox":"0 0 16 16","width":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"},"children":[]}]}]},{"type":"text","value":"Going further"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"The reason we were able to pull the “reply to comment” trick is that Turbo allows us to implement SPA behavior without writing any Javascript. But there are of course limits to what client side experience can be implemented without Javascript."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"This is where you might want to check out "},{"type":"element","tagName":"a","properties":{"href":"https://stimulus.hotwired.dev/","target":"_blank","rel":["nofollow"]},"children":[{"type":"text","value":"Stimulus"}]},{"type":"text","value":". It has many qualities, but the one that’s relevant to this post is that Stimululs does not attempt to render html, but merely adds behvavior to the "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"existing"}]},{"type":"text","value":" (server side rendered) html. And that naturally makes it easier to design solutions that fallback to non-js version."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Check out the previous (pre Turbo) "},{"type":"element","tagName":"a","properties":{"href":"https://featurist.co.uk/blog/progressive-enhancement-in-rails/","target":"_blank","rel":["nofollow"]},"children":[{"type":"text","value":"version"}]},{"type":"text","value":" of this post, where Reddit/HN example is implemented using Turbolinks, UJS and Stimulus to see the example of this."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h2","properties":{"id":"conclusion","style":"position:relative;"},"children":[{"type":"element","tagName":"a","properties":{"href":"#conclusion","ariaLabel":"conclusion permalink","className":["anchor","before"]},"children":[{"type":"element","tagName":"svg","properties":{"ariaHidden":"true","focusable":"false","height":"16","version":"1.1","viewBox":"0 0 16 16","width":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"},"children":[]}]}]},{"type":"text","value":"Conclusion"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Rails allows us to build rich client side UIs without writing a lot of Javascript. This, coupled with support for Progressive Enhancement and "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"rack_test"}]},{"type":"text","value":", provides an opportunity to reduce the reliance on browser tests. Which is a good thing because browser tests are slow and hard to work with."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"All the code snippets above are working. Go ahead and check out the "},{"type":"element","tagName":"a","properties":{"href":"https://github.com/artemave/rails-testing-post","target":"_blank","rel":["nofollow"]},"children":[{"type":"text","value":"example repo"}]},{"type":"text","value":" and see it in action on "},{"type":"element","tagName":"a","properties":{"href":"https://turbo-and-fast-system-tests.herokuapp.com/","target":"_blank","rel":["nofollow"]},"children":[{"type":"text","value":"heroku"}]},{"type":"text","value":" (“Disable JavaScript” in devtools for non-JS version)."}]}],"data":{"quirksMode":false}},"tableOfContents":"<ul>\n<li>\n<p><a href=\"/blog/turbo-and-fast-system-tests/#browser-testing\">Browser testing</a></p>\n<ul>\n<li><a href=\"/blog/turbo-and-fast-system-tests/#problem\">Problem</a></li>\n<li><a href=\"/blog/turbo-and-fast-system-tests/#alternative\">Alternative</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"/blog/turbo-and-fast-system-tests/#rails-system-tests\">Rails system tests</a></p>\n<ul>\n<li><a href=\"/blog/turbo-and-fast-system-tests/#going-headless\">Going headless</a></li>\n<li><a href=\"/blog/turbo-and-fast-system-tests/#rack_test\">rack_test</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"/blog/turbo-and-fast-system-tests/#dealing-with-javascript\">Dealing with Javascript</a></p>\n<ul>\n<li><a href=\"/blog/turbo-and-fast-system-tests/#opting-out-of-rack_test\">Opting out of rack_test</a></li>\n<li><a href=\"/blog/turbo-and-fast-system-tests/#changing-tests-to-support-both-modes\">Changing tests to support both modes</a></li>\n<li><a href=\"/blog/turbo-and-fast-system-tests/#changing-views-to-support-both-modes\">Changing views to support both modes</a></li>\n<li><a href=\"/blog/turbo-and-fast-system-tests/#changing-controllers-to-support-both-modes\">Changing controllers to support both modes</a></li>\n<li><a href=\"/blog/turbo-and-fast-system-tests/#going-further\">Going further</a></li>\n</ul>\n</li>\n<li><a href=\"/blog/turbo-and-fast-system-tests/#conclusion\">Conclusion</a></li>\n</ul>","fields":{"slug":"/blog/turbo-and-fast-system-tests/","readingTime":{"text":"10 min read"}},"frontmatter":{"date":"January 12, 2022","title":"Turbo and fast system tests","subtitles":null,"author":"Artem Avetisyan","short_description":"Build rich UIs with Rails and Turbo and test them without real browser.","hidden":null}}},"pageContext":{"slug":"/blog/turbo-and-fast-system-tests/","prev":{"fileAbsolutePath":"/home/artem/projects/featurist-site-2019/src/data/blog/hosting-rails-apps-for-free-on-oracle-cloud-with-dokku/index.md","fields":{"slug":"/blog/hosting-rails-apps-for-free-on-oracle-cloud-with-dokku/"},"frontmatter":{"title":"Hosting Rails apps for free on Oracle Cloud with Dokku"}},"next":{"fileAbsolutePath":"/home/artem/projects/featurist-site-2019/src/data/blog/progressive-enhancement-in-rails/index.md","fields":{"slug":"/blog/progressive-enhancement-in-rails/"},"frontmatter":{"title":"Progressive Enhancement in Rails: why and how"}}}},"staticQueryHashes":["2665612806","3649515864"]}